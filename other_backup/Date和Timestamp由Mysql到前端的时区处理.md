

最近在开发中碰到了时间时区的问题。当数据库、Tomcat服务器、前端处理不好时区时，容易出现时间错乱的问题。那么对于Mysql库中时间时区的处理，时间从Mysql到前端整个过程中是如何变化的呢？以下是实验的结果：

查询操作如下：

| 数据源Url设置ServerTimeZone(即Mysql) |      | MySql（Asia/Tokyo） | Navicat(根据mysql的时区显示) | unix_timestamp(date/time) | Tomcat（Asia/Shanghai） | Object.toString()            | Date.getTime() | Web（Asia/Shanghai）         |
| ------------------------------------ | ---- | ------------------- | ---------------------------- | ------------------------- | ----------------------- | ---------------------------- | -------------- | ---------------------------- |
|                                      |      |                     |                              |                           |                         |                              |                |                              |
| Asia/Shanghai                        |      | DateTime            | 2019-11-01 00:00:00          | 1572534000                | Date                    |                              |                |                              |
|                                      |      |                     |                              |                           | TimeStamp               |                              |                |                              |
|                                      |      | Timestamp           | 2019-11-01 00:00:00          | 1572534000                | TimeStamp               |                              |                |                              |
|                                      |      |                     |                              |                           | Date                    |                              |                |                              |
|                                      |      |                     |                              |                           |                         |                              |                |                              |
| Asia/Shanghai                        |      | DateTime            | 2019-11-01 00:00:00          | 1572534000                | Date                    | Fri Nov 01 00:00:00 CST 2019 | 1572537600000  | 2019-10-31T16:00:00.000+0000 |
|                                      |      |                     |                              |                           | TimeStamp               | 2019-11-01 00:00:00.0        | 1572537600000  | 2019-10-31T16:00:00.000+0000 |
|                                      |      | Timestamp           | 2019-11-01 00:00:00          | 1572534000                | TimeStamp               | 2019-11-01 00:00:00.0        | 1572537600000  | 2019-10-31T16:00:00.000+0000 |
|                                      |      |                     |                              |                           | Date                    | Fri Nov 01 00:00:00 CST 2019 | 1572537600000  | 2019-10-31T16:00:00.000+0000 |
|                                      |      |                     |                              |                           |                         |                              |                |                              |
| Asia/Tokyo                           |      | DateTime            | 2019-11-01 00:00:00          | 1572534000                | Date                    | Thu Oct 31 23:00:00 CST 2019 | 1572534000000  | 2019-10-31T15:00:00.000+0000 |
|                                      |      |                     |                              |                           | TimeStamp               | 2019-10-31 23:00:00.0        | 1572534000000  | 2019-10-31T15:00:00.000+0000 |
|                                      |      | Timestamp           | 2019-11-01 00:00:00          | 1572534000                | TimeStamp               | 2019-10-31 23:00:00.0        | 1572534000000  | 2019-10-31T15:00:00.000+0000 |
|                                      |      |                     |                              |                           | Date                    | Thu Oct 31 23:00:00 CST 2019 | 1572534000000  | 2019-10-31T15:00:00.000+0000 |
|                                      |      |                     |                              |                           |                         |                              |                |                              |
| UTC                                  |      | DateTime            | 2019-11-01 00:00:00          | 1572534000                | Date                    | Fri Nov 01 08:00:00 CST 2019 | 1572566400000  | 2019-11-01T00:00:00.000+0000 |
|                                      |      |                     |                              |                           | TimeStamp               | 2019-11-01 08:00:00.0        | 1572566400000  | 2019-11-01T00:00:00.000+0000 |
|                                      |      | Timestamp           | 2019-11-01 00:00:00          | 1572534000                | TimeStamp               | 2019-11-01 08:00:00.0        | 1572566400000  | 2019-11-01T00:00:00.000+0000 |
|                                      |      |                     |                              |                           | Date                    | Fri Nov 01 08:00:00 CST 2019 | 1572566400000  | 2019-11-01T00:00:00.000+0000 |
|                                      |      |                     |                              |                           |                         |                              |                |                              |
| default（会自动设为Mysql时区）       |      | DateTime            | 2019-11-01 00:00:00          | 1572534000                | Date                    | Thu Oct 31 23:00:00 CST 2019 | 1572534000000  | 2019-10-31T15:00:00.000+0000 |
|                                      |      |                     |                              |                           | TimeStamp               | 2019-10-31 23:00:00.0        | 1572534000000  | 2019-10-31T15:00:00.000+0000 |
|                                      |      | Timestamp           | 2019-11-01 00:00:00          | 1572534000                | TimeStamp               | 2019-10-31 23:00:00.0        | 1572534000000  | 2019-10-31T15:00:00.000+0000 |
|                                      |      |                     |                              |                           | Date                    | Thu Oct 31 23:00:00 CST 2019 | 1572534000000  | 2019-10-31T15:00:00.000+0000 |

插入操作如下，数据流向由右向左看：

| 插入                           |      |           |                     |            |           |                              |               |               |
| ------------------------------ | ---- | --------- | ------------------- | ---------- | --------- | ---------------------------- | ------------- | ------------- |
| default（会自动设为Mysql时区） |      | DateTime  | 2019-11-01 00:00:00 | 1572534000 | Date      | Thu Oct 31 23:00:00 CST 2019 | 1572534000000 | 1572534000000 |
|                                |      | TimeStamp | 2019-11-01 00:00:00 | 1572534000 |           |                              |               |               |
|                                |      | TimeStamp | 2019-11-01 00:00:00 | 1572534000 | TimeStamp | 2019-10-31 23:00:00.0        | 1572534000000 | 1572534000000 |
|                                |      | DateTime  | 2019-11-01 00:00:00 | 1572534000 |           |                              |               |               |
|                                |      |           |                     |            |           |                              |               |               |
| Asia/Shanghai                  |      | DateTime  | 2019-10-31 23:00:00 | 1572530400 | Date      | Thu Oct 31 23:00:00 CST 2019 | 1572534000000 | 1572534000000 |
|                                |      | TimeStamp | 2019-10-31 23:00:00 | 1572530400 |           |                              |               |               |
|                                |      | TimeStamp | 2019-10-31 23:00:00 | 1572530400 | TimeStamp | 2019-10-31 23:00:00.0        | 1572534000000 | 1572534000000 |
|                                |      | DateTime  | 2019-10-31 23:00:00 | 1572530400 |           |                              |               |               |

结论：

1.Navicat查出的日期，都只是字符串形式。DateTime和Timestamp类型查出来格式是一致的，都是yyyy-MM-dd HH:mm:ss格式。Timestamp的字符串不会携带时区信息，它只是在数据库时区修改的时候，日期字符串会自动修改而已。

2.unix_timestamp()函数会根据当前mysql数据库的时区，将日期字符串转为long。这里它处理Timestamp和Datetime都是一样的。个人猜测都是作为yyyy-MM-dd HH:mm:ss日期字符串处理而已，并没有什么区别。可以推断，修改数据库时区前后，unix_timestamp(Timestamp)的值不会有变化，但是unix_timestamp(Datetime)的值会变。

3.Mybatis在接收的时候，不管是Date或是Timestamp，只认日期字符串。然后根据连接url的serverTimeZone参数（表示Mysql服务器时区），对接收到的字符串进行解读。

4.springMVC在解析Date或是Timestamp时，不管Date携带的是哪个时区，都会一律自动转换为UTC时区返回。

5.Timestamp是Date的子类，它的toString方法用的日期是父类的日期。因此，它的toString方法得到的时间字符串，和Date类型一样，是按照当前服务器的时区取出来的。

6.唯一全局统一的，只会是long类型数字。时间字符串都是考虑了时区的。目前来看，用Date或是Timestamp，两者并没有什么区别。

7.总结：(1)Mybatis获取到时间字符串，然后根据数据源配置的serverTimezone处理该时间，自动处理tomcat服务器和mysql服务器的时间差异。如果serverTimezone没配置，那么自动获取mysql服务器设置的mysql时区(CST会有歧义性的坑)。(2)SpringMVC一律将时间对象处理为UTC时区的字符串返回。(3)Date和Timestamp在时间字符串和时间戳的转换上没有什么区别，是等价的。

8.技巧：(1)Mybatis可以用String类型接收数据库的long类型(会自动转换)，也可以用String类型作为数据库long类型的入参(sql语句可以把long数据加引号，对结果无影响)。(2)前端统一用long的字符串传入，后端直接用Timestamp或Date接收即可。SpringMVC会自动转换为当前tomcat时区的对象。(3)理论上来说Timestamp并没有什么卵用，直接用Date就行了。